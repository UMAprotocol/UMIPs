## Headers

| UMIP-84             |                                                                           |
| ------------------- | ------------------------------------------------------------------------- |
| UMIP Title          | Add PUNKETH and PUNKETH_TWAP as price identifiers                         |
| Authors             | Kevin Chan (kevin@umaproject.org), Chase Coleman (chase@umaproject.org)   |
| Status              | Approved                                                                  |
| Created             | April 19, 2021                                                            |
| Discourse Link      | https://discourse.umaproject.org/t/cryptopunks-index/933                  |


# Summary

This UMIP introduces two new price identifiers for a token referred to as `uPUNK`. The token is a synthetic index based on the recent trading prices of CryptoPunks.

The two price identifiers are `PUNKETH` and `PUNKETH_TWAP`.

* `PUNKETH` will typically be used to measure the fair market value at expiration of `uPUNK` and is computed by taking the median most recent purchase price (in ETH) of each unique CryptoPunk traded in the last 30 days.
* `PUNKETH_TWAP` will typically be used to measure the current value of `uPUNK` and is a "self-referential" price. It is computed from the 2-hour TWAP on the highest volume Uniswap ETH/uPUNK pool (for a specified iteration of uPUNK, i.e. uPUNK-0921)

The structure of these price identifiers mimics (in some ways) the ones created for `uGAS` ([UMIP 16](./UMIP-16.md), [UMIP 20](./UMIP-20.md), [UMIP 22](./UMIP-22.md))


# Motivation

There are currently few synthetic non-fungible token (NFT) indexes available in the DeFi space. As NFTs continue to grow in popularity, collectors may find it useful to be able to hedge their investments and other investors may also want to gain NFT exposure without being required to purchase and maintain custody of a NFT.

Creating a CryptoPunks index before branching into other NFTs makes sense because CryptoPunks were the original NFT. As the original NFT, CryptoPunks are highly valued and relatively liquid.

1. What are the financial positions enabled by creating this synthetic that do not already exist?
  - The DVM does not currently support any NFT based indexes. This token will be the first such index and provide a template for others to be created.
2. Please provide an example of a person interacting with a contract that uses this price identifier.
  - A collector wishing to hedge the risk of purchasing a CryptoPunk could mint `uPUNK` which would provide protection against downward price movements in the value of CryptoPunks.
  - An investor who believes that the median trade price of CryptoPunks will increase could purchase `uPUNK` at its current trading price and then hold until the price appreciated.
  - An investor who believes that the median trade price of CryptoPunks will decrease could mint `uPUNK` and sell the minted tokens.


# Data Specifications

All relevant price data is computed using information that can be found directly on the blockchain.

-----------------------------------------

The `PUNKETH_TWAP` price identifier depends on prices drawn from the `PunkBought` events of the CryptoPunk market contract

- Price identifier name: `PUNKETH`
- Markets & Pairs: CryptoPunk Market contract `PunkBought` events. The CryptoPunk contract address is `0xb47e3cd837dDF8e4c57F05d70Ab865de6e193BBB` which you can see at https://etherscan.io/address/0xb47e3cd837ddf8e4c57f05d70ab865de6e193bbb
- Example price providers: Infura and The Graph include information on CryptoPunk contract events
- Cost to use: [Infura](https://infura.io/) supports up to 100,000 requests per day for free. Information also available on [The Graph](https://thegraph.com/)
- Real-time price update frequency: Updated every block
- Historical price update frequency: Updated every block

_Note_: An important fact worth noting is that the original `CryptoPunkMarket` contract has a bug in it that results in CryptoPunk sales that are generated by "accepting a bid" to assign a value of 0 to the `value` field of the `PunkBought` event. We address this in our price feed but, if you choose to write your own implementation, it is important to be aware of this.

-----------------------------------------

The `PUNKETH_TWAP` price identifier depends on prices generated by the Sushiswap pools

- Price identifier name: `PUNKETH_TWAP`
- Markets & Pairs: Uniswap `uPUNK/ETH`
- Example price providers: The Uniswap price data can be obtained directly from the blockchain
- Cost to use: [Infura](https://infura.io/) supports up to 100,000 requests per day for free. This information should also available on [The Graph](https://thegraph.com/)
- Real-time price update frequency: Updated every block
- Historical price update frequency: Updated every block


# Price Feed Implementation

The `PUNKETH` price would require the creation of a new price feed. The pseudo-code for such an identifier is below:

```
# Get the PunkBought Events from the cryptopunk contract
# for the last 30 days
events = getEvents(
    w3, cryptopunk, "PunkBought",
    block_30daysago, block_now
)

# Compute the prices used for each event
events_corrected = []
for event in events:
    # Get the event that generated the transaction
    transaction = get_transaction(web3, event)

    # Decode input data to find function that
    # generated the event
    fn = cryptopunk.decode_input(transaction.input)["function_name"] 
    if fn == 'buyPunk':
        # If the price was generated with `buyPunk` then the
        # value matches the price paid
        _price = event["args"]["value"]
    elif fn == 'acceptBidForPunk':
        # If the price was generated with `acceptBidForPunk` then
        # the price is inaccurate. The most succint way around this is
        # to find all of the bids made for that cryptopunk up until that
        # block and use the most recent bid (which will be the bid that
        # was accepted)
        _price = getEvents(
            w3, cryptopunk, "PunkBidEntered",
            first_block, event["block_number"],
            filters={"punkIndex": event["args"]["punkIndex"]}
        )

    # Save the relevant information
    push(events_corrected,
        {
            "punkIndex": event["args"]["punkIndex"],
            "blockNumber": event["blockNumber"],
            "price": _price
        }
    )

# Create cryptopunks array to store ids
cryptopunks = []

# Create mapping to store most recent price
cryptopunk_blockprice = {}

# Find the last PunkBought event for each CryptoPunk
for event in events_corrected:
    if event.cryptopunk not in cryptopunks:
        push(event.cryptopunk, cryptopunks)
        cryptopunk_blockprice[event.cryptopunk] = {"block": event.block, "value": event.value}
    else:
        if event.block > cryptopunk_blockprice[event.cryptopunk]["block"]:
            cryptopunk_blockprice[event.cryptopunk] = {"block": event.block, "value": event.value}

# Take median of values
median([cryptopunk_blockprice[cryptopunk]["value"] for cryptopunk in cryptopunks])

```

The `PUNKETH` price implementation can be found here in the [uPUNK price feed](https://github.com/UMAprotocol/protocol/pull/2917)

The `PUNKETH_TWAP` price can be determined using the existing [Uniswap price feed](https://github.com/UMAprotocol/protocol/blob/master/packages/financial-templates-lib/src/price-feed/UniswapPriceFeed.js). The only required input would be determining which pool has the highest volume.

An example configuration for the Uniswap feed is below

```
"PUNKETH_TWAP": {
  type: "uniswap",
  uniswapAddress: "0x6E01DB46b183593374A49c0025e42c4bB7Ee3ffA",
  twapLength: 7200
},
```


# Technical Specifications

-----------------------------------------
- Price identifier name: `PUNKETH`
- Base Currency: CryptoPunk
- Quote Currency: ETH
- Rounding: Round to 6 decimal places (seventh decimal place digit >= 5 rounds up and < 5 rounds down)
- Estimated current value of price identifier: 0.022430 (as of 21 April 2021 19:34 UTC)

-----------------------------------------
- Price identifier name: `PUNKETH_TWAP`
- Base Currency: CryptoPunk
- Quote Currency: ETH
- Rounding: Round to 6 decimal places (seventh decimal place digit >= 5 rounds up and < 5 rounds down)
- Estimated current value of price identifier: 0.022430 (as of 21 April 2021 19:34 UTC)



# Rationale

The `PUNKETH` price identifier had a few decisions that we believe were important to the design:

* _CryptoPunks_: As mentioned earlier in this document, we chose to build an index using CryptoPunks because they were the original NFT. This originality has lead to them being highly valued and having consistent enough trade volume.
* _30 day median_: The 30 day median allows for the index to reflect common trading prices across many CryptoPunks rather than to respond to particular transactions
* _Unique CryptoPunks_: We only use the most recent trade price for each CryptoPunk. This is a security feature since if we used each transaction then a single person could trade one CryptoPunk amongst accounts they owned to manipulate the price.
* _Median rather than the mean_: Calculating the mean incorporates the price of every single transaction which means that someone who owned a single CryptoPunk could have a small effect on the price. The median can still be manipulated but, given the uniqueness restriction above, it would require someone to own enough CryptoPunks to make up half of the monthly transactions.

The `PUNKETH_TWAP` price is necessary to support a market in which people may disagree about the fundamental value of the asset going forward. At expiry, there is a clear way to value the `uPUNK`, i.e., the `PUNKETH` price, however, the value of uPUNK prior to that seems less obvious and we'd like to let the markets price the asset.

This self-referential component was also used in uGAS, see [UMIP 22](./umip-22.md) and has proven successful in that context.


# Implementation

### PUNKETH

When a price request is made, the following process should be followed:

1. Retrieve all CryptoPunk `PunkBought` events from the 30 days prior to expiration
2. Identify the last price that each CryptoPunk was traded at using the event data -- Only one price should be produced per CryptoPunk even if they had traded multiple times. Due to a [bug in the CryptoPunk Market](https://github.com/UMAprotocol/UMIPs/pull/261#discussion_r622282931), this isn't as straightforward as reading the most recent value from the `PunkBought` event. The process we use is:
    - Scan through all of the `PunkBought` events and identify the function call that generated the `PunkBought` event:
      - If it was generated by `buyPunk` then use the `PunkBought.value` price
      - If it was generated by `acceptBidForPunk` then we load all of the `PunkBidEntered` for that particular CryptoPunk and use the most recent bid (only one bid can be outstanding at a time and is always the highest)
3. Take the median of these prices - If there is an even number of prices, take the mean of the two values closest to the median.
4. Divide by 1000, and then round to 6 decimals to arrive at the final price.


**Example**

If the timestamp requested was `1619222400` then:

* We would need to identify all `PunkBought` events from `1619222400 - 30 days -> 1616630400` to `1619222400`
* Imagine that we had 5 `PunkBought` events with (`ts`, `punk_id`, `eth`) pairs of `[(1616630450, 1000, 20), (1616631450, 5000, 30), (1616631550, 5000, 35), (1618631550, 6000, 22), (1618632550, 9999, 15)]`.
* We would need to check what function generated each `PunkBought` event. Suppose they were all generated by `buyPunk`, then the prices we would use to compute the median would be `[20, 35, 22, 15]`
* There are an even number of values, so there's no "median value" in the data -- Thus we find the number between the two values closest to the median `[20, 22]` to get a price of `21`
* Divide by `1000` to get a price of `0.021`

### PUNKETH_TWAP

When a price request that relies on this price identifier is made, the following process should be followed:

1. The end TWAP timestamp equals the price request timestamp.
2. The start TWAP timestamp is defined by the end TWAP timestamp - TWAP period (2 hours).
3. A single Uniswap price is defined for each timestamp as the price that the ETH/uPUNK ppool returns at the end of the latest block whose timestamp is less than or equal to the timestamp that is queried for.
4. The TWAP is an average of the prices for each timestamp between the start and end timestamps. Each price in this average will receive equal weight.
5. The final price should be returned with ETH


**Example**

If the timestamp requested was `1619222400` then:

* The end TWAP timestamp would be `1619222400`
* The start TWAP timestamp would be `1619222400 - 7200` -> `1619215200`
* The Uniswap price would be found for \{`1619215200`, `1619215201`, `1619215202`, ..., `1619222400`\}
* Average the prices corresponding with each price and then report this average


# Security Considerations

### PUNKETH

One of the main concerns is that someone with sufficient CryptoPunks chooses to manipulate the price.

For example, there are accounts that own about 400 unique CryptoPunks and the unique number of CryptoPunks that traded in the last 30 days is about 600. An individual who owns 400 CryptoPunks and traded them amongst their own accounts at prices near zero could corrupt the price by driving it to zero after having minted and sold the tokens at a high price.

One benefit to using an oracle with human intervention is that voters could recognize this type of price manipulation and there are other viable proxies for the expected price of a CryptoPunk. For example, if voters felt like there was price manipulation, they could choose to settle the contract at the current market price of `PUNKBASIC` or other

The other main concern is if there were just insufficient CryptoPunk trades being made. If there were only 1-2 trades happening every 30 days, this index becomes much less useful because there's less information contained in its price.

### PUNKETH_TWAP

The main concerns of the TWAP price are:

1. **Token price manipulation**: If the Uniswap pool is not sufficiently liquid, then attackers could try to drive down the Uniswap price and withdraw more collateral than intended. Most DeFi attacks have been done using flash loans, but flash loans would be ineffective since the price is measured at the end of each block. Collateralizaton based on the TWAP price would make it more capital intensive (and thus risky) to target the token price in this way.
2. **TWAP mismatch**: If the price of the token rises quickly then there would become a mismatch between the market price and the TWAP price. This might allow sponsers to mint tokens with less collateral than what they could sell them for on the market. Reasonable levels of collateralizaton requirements and the 2 hour "liveness period" help combat this concern.

Both of these concerns are originally discussed in [UMIP 22](./umip-22.md)
