## Headers

| UMIP-15    |                                                                                            |
| ---------- | ------------------------------------------------------------------------------------------ |
| UMIP Title | Approve Updated DVM Voting Contract to Mitigate Flash-loans During Token Balance Snapshots |
| Authors    | Chris Maree (chris@umaproject.org)                                                         |
| Status     | Approved                                                                                    |
| Created    | September 17, 2020                                                                         |

## Summary

This UMIP proposes an upgrade to the Voting module within the DVM to mitigate the use of flash loan during voting rounds. This upgrade will enforce that DVM balance snapshots are captured from EOA wallets to prevent the use of flash-loans in this context. This upgrade will also change the rewards expiry timeout from 2 weeks to 1000 years, which effectively amounts to no expiration.

## Motivation & Rationale

The UMA voting mechanism uses a commit-reveal scheme, where votes are weighted in proportion to the token balance of the voters. The corresponding snapshot of the token distribution is taken at the start of each reveal phase, either through a dedicated function call, or automatically alongside the first revealed vote.

However, it is possible for users to take out a flash loan of UMA tokens from a decentralized exchange, trigger the snapshot and then repay the loan in a single transaction. This would arguably give them undue influence over the result of the vote. Given the current state of the DeFi ecosystem, the flash-loan scenario is significantly simpler, more plausible, and arguably more concerning, so it warrants a dedicated mitigation.

This UMIP proposes a solution that makes it imposable to utilize flash loans during voting, thereby enforcing that users hold UMA tokens beyond a single block if they wish to participate in governance.

This UMIP was originally motivated by an analysis conducted by the UMA engineering team that identified the issue in July 2020. The analysis can be found [here](https://docs.google.com/document/d/11ap5q2ga2OaVIV6MLxpRjzbLZTr0xraUIt2DdfcyzWI/edit?usp=sharing). There was also a detailed discussion in the OpenZepplin Community forum on the implementation details of this solution which can be found [here](https://forum.openzeppelin.com/t/erc20snapshot-and-flash-loans-swaps-mints/3094).

While redeploying the new version of the contract, the parameters can be reconsidered. The community has expressed dissatisfaction with the 2-week reward expiration. While the voting contract is being modified, it seems prudent to effectively remove this expiration.

## Technical Specification

This UMIP addresses the flash-loan scenario by requiring the address that triggers the snapshot to provide an ECDSA signature over a known message, which guarantees that it is an externally owned account(EOA). For simplicity, the ability to automatically trigger a snapshot on the reveal has been removed, although the same effect can be achieved with multiple function calls.

The implications of this are that the first revealer is required to submit two transactions:

1. Call `snapshotCurrentRound` with an ECDSA signature which is used to capture the UMA token balances for the voting round. The inclusion of this signature ensures that only EOAs can preform the snapshot as an ECDSA signature can not be generated by a smart contract within a flash-loan.
2. Call `revealVote` to reveal their vote in the normal flash-loan.

All subsequent voters can call `revealVote` as they would previously have done.

As for the rewards expiration, voters will be able to wait as long as they like before retrieving their rewards.

## Implementation

Please see this [directory](https://github.com/UMAprotocol/protocol/tree/master/packages/core/contracts/oracle). The directory contains the [implementation](https://github.com/UMAprotocol/protocol/blob/master/packages/core/contracts/oracle/implementation/Voting.sol) of the `Voting` contract which preforms the key voting logic within the DVM and has the updated logic to include the ECDSA signature verification.

The specific changes made in this UMIP can be seen in [this](https://github.com/UMAprotocol/protocol/pull/1767) pull request.

The new Voting contract should have identical parameters to the pre-existing Voting contract, except that rewardsExpirationTimeout will be equal to `31536000000` (1000 years in seconds). 

## Security considerations

These changes _have_ been audited by OpenZeppelin and the full audit report can be read [here](https://blog.openzeppelin.com/uma-audit-phase-3/).
